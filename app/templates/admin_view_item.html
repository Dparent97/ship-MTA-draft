{% extends "base.html" %}

{% block title %}{{ work_item.item_number }} Details{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
        ‚Üê Back to Dashboard
    </a>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">{{ work_item.item_number }}</h3>
                <span class="badge bg-light text-dark">Editable</span>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.edit_item', item_id=work_item.id) }}" enctype="multipart/form-data" id="editForm">
                    <!-- Item Number -->
                    <div class="mb-4">
                        <label for="item_number" class="form-label"><h5>Item Number</h5></label>
                        <input type="text" class="form-control form-control-lg" id="item_number" 
                               name="item_number" value="{{ work_item.item_number }}" required spellcheck="true">
                    </div>
                    
                    <!-- Location -->
                    <div class="mb-4">
                        <label for="location" class="form-label"><h5>Location</h5></label>
                        <input type="text" class="form-control form-control-lg" id="location" 
                               name="location" value="{{ work_item.location }}" required spellcheck="true">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="description" class="form-label"><h5>Description</h5></label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" required spellcheck="true">{{ work_item.description }}</textarea>
                    </div>
                    
                    <!-- Detail -->
                    <div class="mb-4">
                        <label for="detail" class="form-label"><h5>Detail</h5></label>
                        <textarea class="form-control" id="detail" name="detail" 
                                  rows="6" required spellcheck="true">{{ work_item.detail }}</textarea>
                    </div>
                    
                    <!-- Operator Furnished Material -->
                    <div class="mb-4">
                        <label for="references" class="form-label"><h5>Operator Furnished Material (OFM)</h5></label>
                        <textarea class="form-control" id="references" name="references" 
                                  rows="3" spellcheck="true">{{ work_item.references or '' }}</textarea>
                    </div>
                
                    <!-- Photos -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">üì∑ Photos</h5>
                            {% if work_item.photos %}
                            <span class="photo-count-badge">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                </svg>
                                {{ work_item.photos|length }} photo{% if work_item.photos|length != 1 %}s{% endif %}
                            </span>
                            {% endif %}
                        </div>

                        {% if work_item.photos %}
                        <!-- Photo Gallery Grid with Lightbox -->
                        <div class="photo-gallery-grid mb-3">
                            {% for photo in work_item.photos %}
                            <div class="photo-gallery-item"
                                 data-full-url="{{ url_for('serve_upload', filename=photo.filename) }}"
                                 data-caption="{{ photo.caption or '' }}">
                                <img src="{{ url_for('serve_upload', filename=photo.filename) }}"
                                     alt="{{ photo.caption or 'Photo ' ~ loop.index }}"
                                     loading="lazy">
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Editable Photo Details -->
                        <div class="accordion" id="photoDetailsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="photoDetailsHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#photoDetailsCollapse" aria-expanded="false" aria-controls="photoDetailsCollapse">
                                        Edit Photo Captions & Manage Photos
                                    </button>
                                </h2>
                                <div id="photoDetailsCollapse" class="accordion-collapse collapse" aria-labelledby="photoDetailsHeading" data-bs-parent="#photoDetailsAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            {% for photo in work_item.photos %}
                                            <div class="col-md-6 col-12">
                                                <div class="card">
                                                    <img src="{{ url_for('serve_upload', filename=photo.filename) }}"
                                                         class="card-img-top" alt="Photo {{ loop.index }}"
                                                         style="max-height: 200px; object-fit: cover;">
                                                    <div class="card-body">
                                                        <label class="form-label"><strong>Photo {{ loop.index }} Caption:</strong></label>
                                                        <input type="hidden" name="photo_ids[]" value="{{ photo.id }}">
                                                        <input type="text" class="form-control mb-3"
                                                               name="photo_captions[]" value="{{ photo.caption }}"
                                                               placeholder="Add caption...">
                                                        <div class="row g-2">
                                                            <div class="col-6">
                                                                <a href="{{ url_for('admin.download_photo', item_id=work_item.id, photo_id=photo.id) }}"
                                                                   class="btn btn-sm btn-outline-primary w-100">
                                                                    üì• Download
                                                                </a>
                                                            </div>
                                                            <div class="col-6">
                                                                <button type="button" class="btn btn-sm btn-outline-danger w-100"
                                                                        onclick="if(confirm('Delete this photo?')) { window.location.href='{{ url_for('admin.delete_photo', item_id=work_item.id, photo_id=photo.id) }}'; }">
                                                                    üóëÔ∏è Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                            </svg>
                            No photos attached to this work item yet.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add New Photos Section -->
                    <div class="mb-4">
                        <h5>üì∏ Add New Photos</h5>
                        <p class="text-muted small">Tap to use camera or choose from gallery</p>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div id="newPhotoContainer">
                                    <!-- New photo inputs will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary w-100" id="addNewPhotoBtn">
                                    üì∑ Add Photo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button - Desktop -->
                    <div class="d-none d-md-block">
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                </svg>
                                Save All Changes
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Mobile Fixed Bottom Save Button -->
                <div class="d-md-none mobile-fixed-bottom">
                    <button type="submit" form="editForm" class="btn btn-success btn-lg w-100">
                        ‚úì Save All Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Actions -->
    <div class="col-lg-4">
        <!-- Status Card -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">Status & Actions</h5>
            </div>
            <div class="card-body">
                <!-- Current Status -->
                <div class="mb-3">
                    <strong>Current Status:</strong><br>
                    <span class="badge 
                        {% if work_item.status == 'Submitted' %}bg-primary
                        {% elif work_item.status == 'In Review by DP' %}bg-warning text-dark
                        {% elif work_item.status == 'In Review by AL' %}bg-warning text-dark
                        {% elif work_item.status == 'Needs Revision' %}bg-danger
                        {% elif work_item.status == 'Awaiting Photos' %}bg-info
                        {% elif work_item.status == 'Completed Review' %}bg-success
                        {% else %}bg-secondary{% endif %} mt-2">
                        {{ work_item.status }}
                    </span>
                </div>
                
                <!-- Assignment & Status Update Form -->
                <form method="POST" action="{{ url_for('admin.assign_item', item_id=work_item.id) }}">
                    <div class="mb-3">
                        <label class="form-label">Change Status:</label>
                        <select class="form-select" name="status">
                            <option value="Submitted" {% if work_item.status == 'Submitted' %}selected{% endif %}>Submitted</option>
                            <option value="In Review by DP" {% if work_item.status == 'In Review by DP' %}selected{% endif %}>In Review by DP</option>
                            <option value="In Review by AL" {% if work_item.status == 'In Review by AL' %}selected{% endif %}>In Review by AL</option>
                            <option value="Needs Revision" {% if work_item.status == 'Needs Revision' %}selected{% endif %}>Needs Revision</option>
                            <option value="Awaiting Photos" {% if work_item.status == 'Awaiting Photos' %}selected{% endif %}>Awaiting Photos</option>
                            <option value="Completed Review" {% if work_item.status == 'Completed Review' %}selected{% endif %}>Completed Review</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign To:</label>
                        <select class="form-select" name="assigned_to">
                            <option value="">-- None --</option>
                            <option value="DP" {% if work_item.assigned_to == 'DP' %}selected{% endif %}>DP</option>
                            <option value="AL" {% if work_item.assigned_to == 'AL' %}selected{% endif %}>AL</option>
                            <option value="Kaitlyn" {% if work_item.assigned_to == 'Kaitlyn' %}selected{% endif %}>Kaitlyn</option>
                            <option value="Mark" {% if work_item.assigned_to == 'Mark' %}selected{% endif %}>Mark</option>
                            <option value="Art" {% if work_item.assigned_to == 'Art' %}selected{% endif %}>Art</option>
                            <option value="D2" {% if work_item.assigned_to == 'D2' %}selected{% endif %}>D2</option>
                            <option value="Zach" {% if work_item.assigned_to == 'Zach' %}selected{% endif %}>Zach</option>
                            <option value="Maverick" {% if work_item.assigned_to == 'Maverick' %}selected{% endif %}>Maverick</option>
                            <option value="Rhyan" {% if work_item.assigned_to == 'Rhyan' %}selected{% endif %}>Rhyan</option>
                        </select>
                        <small class="text-muted">Assign someone to complete/revise this item</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Revision Notes:</label>
                        <textarea class="form-control" name="revision_notes" rows="3" 
                                  placeholder="Tell the crew member what needs to be fixed or added..." spellcheck="true">{{ work_item.revision_notes or '' }}</textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-warning w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightning" viewBox="0 0 16 16">
                            <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/>
                        </svg>
                        Update Assignment
                    </button>
                </form>
                
                <hr>
                
                <!-- Download Button -->
                <a href="{{ url_for('admin.download_single', item_id=work_item.id) }}" 
                   class="btn btn-success w-100 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Download .docx
                </a>
                
                <hr>
                
                <!-- Delete Button (with confirmation) -->
                <form method="POST" action="{{ url_for('admin.delete_item', item_id=work_item.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this work item? This cannot be undone.');">
                    <button type="submit" class="btn btn-danger w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        Delete Item
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Metadata Card -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">Metadata</h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>Submitted by:</strong><br>
                    {{ work_item.submitter_name }}
                </p>
                <p class="mb-2">
                    <strong>Submitted at:</strong><br>
                    {{ format_datetime(work_item.submitted_at) }}
                </p>
                <p class="mb-0">
                    <strong>Photos:</strong><br>
                    {{ work_item.photos|length }} attached
                </p>
            </div>
        </div>

        <!-- Admin Notes Card -->
        <div class="card shadow">
            <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#adminNotesCollapse" aria-expanded="true">
                <h5 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill me-2" viewBox="0 0 16 16">
                        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                    </svg>
                    Admin Notes
                    <small class="text-muted">(Internal Only)</small>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down float-end" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </h5>
            </div>
            <div id="adminNotesCollapse" class="collapse show">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.save_admin_notes', item_id=work_item.id) }}" id="adminNotesForm">
                        <div class="mb-3">
                            <textarea class="form-control" name="admin_notes" rows="6"
                                      placeholder="Add internal notes here... These notes are only visible to admin users and will never be shown to crew members."
                                      spellcheck="true">{{ work_item.admin_notes or '' }}</textarea>
                        </div>

                        {% if work_item.admin_notes_updated_at %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clock" viewBox="0 0 16 16">
                                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                </svg>
                                Last updated: {{ format_datetime(work_item.admin_notes_updated_at) }}
                            </small>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary w-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                            </svg>
                            Save Admin Notes
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let newPhotoCount = 0;

// Add class to body for mobile fixed bottom padding
if (window.innerWidth < 768) {
    document.body.classList.add('has-fixed-bottom');
}

// Handle window resize
window.addEventListener('resize', function() {
    if (window.innerWidth < 768) {
        document.body.classList.add('has-fixed-bottom');
    } else {
        document.body.classList.remove('has-fixed-bottom');
    }
});

document.getElementById('addNewPhotoBtn').addEventListener('click', function() {
    newPhotoCount++;
    const photoDiv = document.createElement('div');
    photoDiv.className = 'mb-3 card';
    photoDiv.id = `new-photo-${newPhotoCount}`;
    photoDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">üì∑ New Photo ${newPhotoCount}</label>
                    <input type="file" class="form-control" name="new_photos[]"
                           accept="image/jpeg,image/jpg,image/png,image/heic,image/heif"
                           capture="environment">
                    <small class="form-text text-muted">Tap to use camera or choose from gallery</small>
                </div>
                <div class="col-12 mb-2">
                    <label class="form-label">Caption (Optional)</label>
                    <input type="text" class="form-control" name="new_photo_captions[]"
                           placeholder="Describe what this photo shows">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.card').remove()">
                üóëÔ∏è Remove Photo ${newPhotoCount}
            </button>
        </div>
    `;
    document.getElementById('newPhotoContainer').appendChild(photoDiv);
});
</script>
{% endblock %}
