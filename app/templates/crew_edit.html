{% extends "base.html" %}

{% block title %}Edit Work Item - {{ work_item.item_number }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Revision Notes Alert (Prominent Display) -->
        {% if work_item.revision_notes %}
        <div class="alert alert-warning border-warning shadow-sm mb-4">
            <h4 class="alert-heading">
                <i class="bi bi-pencil-square"></i> Revision Notes from {{ work_item.last_modified_by or 'Admin' }}
            </h4>
            <hr>
            <p class="mb-0" style="white-space: pre-wrap;">{{ work_item.revision_notes }}</p>
            <hr>
            <small class="text-muted">
                Please address these points before resubmitting. Once you save, the status will change to "Submitted" for review.
            </small>
        </div>
        {% endif %}

        <!-- Edit Form Card -->
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0">Edit Work Item</h3>
                <small>Editing as: <strong>{{ crew_name }}</strong> | Status: <span class="badge bg-dark">{{ work_item.status }}</span></small>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="editWorkItemForm">

                    <!-- Read-Only Item Number -->
                    <div class="mb-3">
                        <label class="form-label">Item Number (Cannot be changed)</label>
                        <input type="text" class="form-control" value="{{ work_item.item_number }}"
                               readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        <small class="form-text text-muted">
                            This field cannot be modified after submission.
                        </small>
                    </div>

                    <!-- Read-Only Location -->
                    <div class="mb-3">
                        <label class="form-label">Location (Cannot be changed)</label>
                        <input type="text" class="form-control" value="{{ work_item.location }}"
                               readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        <small class="form-text text-muted">
                            This field cannot be modified after submission.
                        </small>
                    </div>

                    <hr class="my-4">
                    <h5 class="mb-3">Editable Fields</h5>

                    <!-- Description (Editable) -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Brief Summary) *</label>
                        <textarea class="form-control" id="description" name="description"
                                  rows="2" maxlength="200" required spellcheck="true"
                                  placeholder="Brief 1-2 sentence description (max 200 characters)">{{ work_item.description }}</textarea>
                        <small class="form-text text-muted">
                            Example: "Port & Stbd ME Exhaust insulation overhaul"
                        </small>
                    </div>

                    <!-- Detail (Editable) -->
                    <div class="mb-3">
                        <label for="detail" class="form-label">Detail (Complete Description) *</label>
                        <textarea class="form-control" id="detail" name="detail"
                                  rows="6" required spellcheck="true"
                                  placeholder="Include: What needs to be done, Why, Scope of work, WO numbers, Equipment specs, Regulatory requirements">{{ work_item.detail }}</textarea>
                        <small class="form-text text-muted">
                            Provide comprehensive details including what needs to be done, why, scope, WO numbers, equipment specs, and any regulatory requirements.
                        </small>
                    </div>

                    <!-- References/OFM (Editable) -->
                    <div class="mb-3">
                        <label for="references" class="form-label">Operator Furnished Material (OFM)</label>
                        <textarea class="form-control" id="references" name="references"
                                  rows="3" spellcheck="true"
                                  placeholder="If known, list materials on order or onboard (e.g., part numbers, descriptions). Otherwise write 'None'.">{{ work_item.references or '' }}</textarea>
                        <small class="form-text text-muted">
                            List any materials, parts, or equipment that need to be provided for this work item.
                        </small>
                    </div>

                    <hr class="my-4">

                    <!-- Existing Photos Section -->
                    <h5 class="mb-3">Existing Photos</h5>

                    {% if work_item.photos %}
                    <div id="existingPhotosContainer">
                        {% for photo in work_item.photos %}
                        <div class="card mb-3" id="existing-photo-{{ photo.id }}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <img src="{{ url_for('serve_upload', filename=photo.filename) }}"
                                             class="img-fluid rounded" alt="Work item photo">
                                    </div>
                                    <div class="col-md-8 mb-2">
                                        <label class="form-label">Photo Caption</label>
                                        <input type="hidden" name="photo_ids[]" value="{{ photo.id }}">
                                        <input type="text" class="form-control mb-2"
                                               name="photo_captions[]"
                                               value="{{ photo.caption }}"
                                               placeholder="Describe what this photo shows">
                                        <a href="{{ url_for('crew.delete_assigned_photo', item_id=work_item.id, photo_id=photo.id) }}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this photo?')">
                                            Delete Photo
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No existing photos.</p>
                    {% endif %}

                    <hr class="my-4">

                    <!-- Add New Photos Section -->
                    <h5 class="mb-3">Add New Photos</h5>
                    <p class="text-muted small mb-3">
                        Drag and drop photos or click to upload (Maximum {{ max_photos }} total)
                    </p>

                    <div id="photoUploadContainer" data-max-photos="{{ max_photos }}" data-min-photos="0">
                        <!-- Photo upload UI will be injected here by photo-upload.js -->
                    </div>

                    <hr class="my-4">

                    <!-- Save Button -->
                    <div class="alert alert-info">
                        <strong>Note:</strong> When you save your changes:
                        <ul class="mb-0 mt-2">
                            <li>Status will change from "{{ work_item.status }}" to "Submitted"</li>
                            <li>The item will be sent back for admin review</li>
                            <li>Revision notes will be cleared</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            Save Changes & Resubmit
                        </button>
                        <a href="{{ url_for('crew.submit_form') }}" class="btn btn-outline-secondary">
                            Cancel & Return to Form
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/photo-upload.js') }}"></script>
<script>
// Adjust max photos based on existing photos count
document.addEventListener('DOMContentLoaded', function() {
    const existingPhotosCount = document.querySelectorAll('#existingPhotosContainer .card').length;
    const maxPhotos = {{ max_photos }};
    const container = document.getElementById('photoUploadContainer');

    if (container && window.photoUploadManager) {
        // Adjust the max photos to account for existing photos
        const remainingSlots = maxPhotos - existingPhotosCount;
        window.photoUploadManager.maxPhotos = remainingSlots;
        window.photoUploadManager.updateDropZoneVisibility();
    }
});

// Form submission - append new photos to form data with double-submit protection
let isSubmitting = false;

document.getElementById('editWorkItemForm').addEventListener('submit', function(e) {
    // Prevent double submission
    if (isSubmitting) {
        e.preventDefault();
        return;
    }

    // Confirm before submitting
    const confirmed = confirm('Are you sure you want to save these changes? The item will be resubmitted for review with status "Submitted".');
    if (!confirmed) {
        e.preventDefault();
        return;
    }

    isSubmitting = true;
    e.preventDefault();

    // Get submit button and disable it
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';

    // Create FormData from the form
    const formData = new FormData(this);

    // Remove any existing new photo data (old system compatibility)
    formData.delete('new_photos[]');
    formData.delete('new_photo_captions[]');

    // Add new photos from the upload manager
    if (window.photoUploadManager) {
        const photos = window.photoUploadManager.getPhotos();
        photos.forEach(photo => {
            formData.append('new_photos[]', photo.file);
            formData.append('new_photo_captions[]', photo.caption || '');
        });
    }

    // Submit the form
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Redirect to success page or reload
            window.location.href = response.url;
        } else {
            return response.text().then(text => {
                throw new Error('Form submission failed: ' + text);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('There was an error submitting the form. Please try again.');
        
        // Re-enable button on error
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
});
</script>
{% endblock %}
