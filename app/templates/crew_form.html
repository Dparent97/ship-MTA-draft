{% extends "base.html" %}

{% block title %}Crew Dashboard{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Assigned Items Banner (Always Visible) -->
        {% if assigned_items %}
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">üìã Your Assigned Items ({{ assigned_items|length }})</h4>
            </div>
            <div class="card-body">
                {% for item in assigned_items %}
                <div class="card mb-3 border-warning">
                    <div class="card-body">
                        <h5>{{ item.item_number }}</h5>
                        <p class="mb-1"><strong>Location:</strong> {{ item.location }}</p>
                        <p class="mb-1"><strong>Assigned by:</strong> {{ item.last_modified_by or 'Admin' }}</p>
                        <p class="mb-1"><strong>Status:</strong> 
                            <span class="badge bg-warning text-dark">{{ item.status }}</span>
                        </p>
                        {% if item.revision_notes %}
                        <div class="alert alert-info mb-2 mt-2">
                            <strong>üìù Revision Notes:</strong><br>
                            {{ item.revision_notes }}
                        </div>
                        {% endif %}
                        <a href="{{ url_for('crew.edit_assigned_item', item_id=item.id) }}" 
                           class="btn btn-primary">
                            Edit This Item
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Main Dashboard Card with Tabs -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Crew Dashboard</h3>
                <small>Logged in as: <strong>{{ crew_name }}</strong></small>
            </div>
            <div class="card-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-4" id="crewDashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="submit-tab" data-bs-toggle="tab" 
                                data-bs-target="#submit-pane" type="button" role="tab">
                            Submit New
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="progress-tab" data-bs-toggle="tab" 
                                data-bs-target="#progress-pane" type="button" role="tab">
                            In Progress
                            <span class="badge bg-secondary">{{ in_progress_items|length }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" 
                                data-bs-target="#completed-pane" type="button" role="tab">
                            Completed
                            <span class="badge bg-success">{{ completed_items|length }}</span>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="crewDashboardTabContent">
                    
                    <!-- TAB 1: SUBMIT NEW -->
                    <div class="tab-pane fade show active" id="submit-pane" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data" id="workItemForm">
                            
                            <!-- Item Number with Collapsible Reference Section -->
                            <div class="mb-3">
                                <label for="item_number" class="form-label">
                                    Item Number
                                    <small class="text-muted">(Auto-generated, or enter custom)</small>
                                </label>
                                <input type="text" class="form-control" id="item_number" 
                                       name="item_number" value="{{ next_item_number }}" 
                                       placeholder="e.g., DRAFT_0020 or 0101">
                                
                                <!-- Collapsible Reference Section -->
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#referenceSection">
                                        üìö Reference existing item (optional)
                                    </button>
                                </div>
                                
                                <div class="collapse mt-3" id="referenceSection">
                                    <div class="card card-body bg-light">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">EV Yard Items</label>
                                                <select class="form-select form-select-sm" id="ev_yard_select">
                                                    <option value="">-- Select --</option>
                                                    {% for item in ev_yard_items %}
                                                    <option value="{{ item.split(' - ')[0] }}">{{ item }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">Draft Items</label>
                                                <select class="form-select form-select-sm" id="draft_select">
                                                    <option value="">-- Select --</option>
                                                    {% for item in draft_items %}
                                                    <option value="{{ item.split(' - ')[0] }}">{{ item }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <small class="text-muted">Selecting an item will populate the item number field above.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location -->
                            <div class="mb-3">
                                <label for="location" class="form-label">Location *</label>
                                <input type="text" class="form-control" id="location" 
                                       name="location" placeholder="e.g., Engine Room STBD AFT, Pilot House FWD PORT Console" 
                                       required spellcheck="true">
                                <small class="form-text text-muted">
                                    Be specific with location details including: compartment, side (PORT/STBD), position (FWD/AFT), deck level, frame numbers, equipment location
                                </small>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Brief Summary) *</label>
                                <textarea class="form-control" id="description" name="description" 
                                          rows="2" maxlength="200" required spellcheck="true"
                                          placeholder="Brief 1-2 sentence description (max 200 characters)"></textarea>
                                <small class="form-text text-muted">
                                    Example: "Port & Stbd ME Exhaust insulation overhaul"
                                </small>
                            </div>
                            
                            <!-- Detail -->
                            <div class="mb-3">
                                <label for="detail" class="form-label">Detail (Complete Description) *</label>
                                <textarea class="form-control" id="detail" name="detail" 
                                          rows="6" required spellcheck="true"
                                          placeholder="Include: What needs to be done, Why, Scope of work, WO numbers, Equipment specs, Regulatory requirements"></textarea>
                                <small class="form-text text-muted">
                                    Provide comprehensive details including what needs to be done, why, scope, WO numbers, equipment specs, and any regulatory requirements.
                                </small>
                            </div>
                            
                            <!-- Operator Furnished Material -->
                            <div class="mb-3">
                                <label for="references" class="form-label">Operator Furnished Material (OFM)</label>
                                <textarea class="form-control" id="references" name="references" 
                                          rows="3" spellcheck="true"
                                          placeholder="If known, list materials on order or onboard (e.g., part numbers, descriptions). Otherwise write 'None'."></textarea>
                                <small class="form-text text-muted">
                                    List any materials, parts, or equipment that need to be provided for this work item.
                                </small>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Photos Section -->
                            <h5 class="mb-3">üì∏ Photos (Optional, Maximum {{ max_photos }})</h5>
                            <p class="text-muted small mb-3">
                                Tip: Use your device's camera to capture photos directly
                            </p>

                            <div id="photoContainer">
                                <!-- Photo inputs will be added dynamically -->
                            </div>

                            <button type="button" class="btn btn-secondary mb-3 w-100" id="addPhotoBtn">
                                üì∑ Add Photo
                            </button>

                            <hr class="my-4">

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    ‚úì Submit Work Item
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- TAB 2: IN PROGRESS -->
                    <div class="tab-pane fade" id="progress-pane" role="tabpanel">
                        <h4 class="mb-3">In Progress Items ({{ in_progress_items|length }})</h4>
                        
                        {% if in_progress_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item #</th>
                                        <th>Location</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Submitted By</th>
                                        <th>Photos</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in in_progress_items %}
                                    <tr>
                                        <td><strong>{{ item.item_number }}</strong></td>
                                        <td>{{ item.location|truncate(30) }}</td>
                                        <td>{{ item.description|truncate(40) }}</td>
                                        <td><span class="badge bg-info">{{ item.status }}</span></td>
                                        <td>{{ item.submitter_name }}</td>
                                        <td>{{ item.photos|length }}</td>
                                        <td>
                                            {% if item.submitter_name == crew_name or item.assigned_to == crew_name %}
                                                {% if item.status in ['Needs Revision', 'Awaiting Photos'] %}
                                                <a href="{{ url_for('crew.edit_assigned_item', item_id=item.id) }}" 
                                                   class="btn btn-sm btn-warning">Edit</a>
                                                {% else %}
                                                <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                                   class="btn btn-sm btn-info">View</a>
                                                {% endif %}
                                            {% else %}
                                            <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                               class="btn btn-sm btn-info">View</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p class="mb-0">No items in progress at this time.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- TAB 3: COMPLETED -->
                    <div class="tab-pane fade" id="completed-pane" role="tabpanel">
                        <h4 class="mb-3">Completed Items ({{ completed_items|length }})</h4>
                        
                        {% if completed_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item #</th>
                                        <th>Location</th>
                                        <th>Description</th>
                                        <th>Submitted By</th>
                                        <th>Photos</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in completed_items %}
                                    <tr>
                                        <td><strong>{{ item.item_number }}</strong></td>
                                        <td>{{ item.location|truncate(30) }}</td>
                                        <td>{{ item.description|truncate(40) }}</td>
                                        <td>{{ item.submitter_name }}</td>
                                        <td>{{ item.photos|length }}</td>
                                        <td>
                                            <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                               class="btn btn-sm btn-success">View</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p class="mb-0">No completed items yet.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Reference dropdown selection - populate main item number input
document.getElementById('ev_yard_select').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('item_number').value = this.value;
        document.getElementById('draft_select').value = ''; // Clear other dropdown
    }
});

document.getElementById('draft_select').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('item_number').value = this.value;
        document.getElementById('ev_yard_select').value = ''; // Clear other dropdown
    }
});

// Photo management
let photoCount = 0;
const minPhotos = {{ min_photos }};
const maxPhotos = {{ max_photos }};

function addPhotoInput() {
    if (photoCount >= maxPhotos) {
        alert(`Maximum ${maxPhotos} photos allowed`);
        return;
    }

    photoCount++;
    const photoDiv = document.createElement('div');
    photoDiv.className = 'card mb-3 photo-input';
    photoDiv.id = `photo-${photoCount}`;
    photoDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">üì∑ Photo ${photoCount}</label>
                    <input type="file" class="form-control" name="photos"
                           accept="image/jpeg,image/jpg,image/png,image/heic,image/heif"
                           capture="environment">
                    <small class="form-text text-muted">Tap to use camera or choose from gallery</small>
                </div>
                <div class="col-12 mb-2">
                    <label class="form-label">Caption (Optional)</label>
                    <input type="text" class="form-control" name="photo_captions"
                           placeholder="Describe what this photo shows">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-danger w-100" onclick="removePhoto(${photoCount})">
                üóëÔ∏è Remove Photo ${photoCount}
            </button>
        </div>
    `;

    document.getElementById('photoContainer').appendChild(photoDiv);
    updateAddPhotoButton();
}

function removePhoto(num) {
    const photoDiv = document.getElementById(`photo-${num}`);
    if (photoDiv) {
        photoDiv.remove();
        photoCount--;
        updateAddPhotoButton();
    }
}

function updateAddPhotoButton() {
    const btn = document.getElementById('addPhotoBtn');
    if (photoCount >= maxPhotos) {
        btn.disabled = true;
        btn.textContent = `Maximum ${maxPhotos} photos reached`;
    } else {
        btn.disabled = false;
        btn.textContent = 'üì∑ Add Photo';
    }
}

// Add event listener to the Add Photo button
document.getElementById('addPhotoBtn').addEventListener('click', addPhotoInput);

// Form validation
document.getElementById('workItemForm').addEventListener('submit', function(e) {
    // Could add other validation here if needed
});
</script>
{% endblock %}
