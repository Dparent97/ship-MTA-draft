{% extends "base.html" %}
{% from "_macros.html" import status_badge, status_badge_simple %}

{% block title %}Crew Dashboard{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Assigned Items Banner (Always Visible) -->
        {% if assigned_items %}
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">üìã Your Assigned Items ({{ assigned_items|length }})</h4>
            </div>
            <div class="card-body">
                {% for item in assigned_items %}
                <div class="card mb-3 border-warning">
                    <div class="card-body">
                        <h5>{{ item.item_number }}</h5>
                        <p class="mb-1"><strong>Location:</strong> {{ item.location }}</p>
                        <p class="mb-1"><strong>Assigned by:</strong> {{ item.last_modified_by or 'Admin' }}</p>
                        <p class="mb-1"><strong>Status:</strong>
                            {{ status_badge(item.status, item, true, 'sm') }}
                        </p>
                        {% if item.revision_notes %}
                        <div class="alert alert-info mb-2 mt-2">
                            <strong>üìù Revision Notes:</strong><br>
                            {{ item.revision_notes }}
                        </div>
                        {% endif %}
                        <a href="{{ url_for('crew.edit_assigned_item', item_id=item.id) }}" 
                           class="btn btn-primary">
                            Edit This Item
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Main Dashboard Card with Tabs -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Crew Dashboard</h3>
                <small>Logged in as: <strong>{{ crew_name }}</strong></small>
            </div>
            <div class="card-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-4" id="crewDashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="submit-tab" data-bs-toggle="tab" 
                                data-bs-target="#submit-pane" type="button" role="tab">
                            Submit New
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="progress-tab" data-bs-toggle="tab" 
                                data-bs-target="#progress-pane" type="button" role="tab">
                            In Progress
                            <span class="badge bg-secondary">{{ in_progress_items|length }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" 
                                data-bs-target="#completed-pane" type="button" role="tab">
                            Completed
                            <span class="badge bg-success">{{ completed_items|length }}</span>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="crewDashboardTabContent">
                    
                    <!-- TAB 1: SUBMIT NEW -->
                    <div class="tab-pane fade show active" id="submit-pane" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data" id="workItemForm">
                            
                            <!-- Item Number with Collapsible Reference Section -->
                            <div class="mb-3">
                                <label for="item_number" class="form-label">
                                    Item Number
                                    <small class="text-muted">(Auto-generated, or enter custom)</small>
                                </label>
                                <input type="text" class="form-control" id="item_number" 
                                       name="item_number" value="{{ next_item_number }}" 
                                       placeholder="e.g., DRAFT_0020 or 0101">
                                
                                <!-- Collapsible Reference Section -->
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#referenceSection">
                                        üìö Reference existing item (optional)
                                    </button>
                                </div>
                                
                                <div class="collapse mt-3" id="referenceSection">
                                    <div class="card card-body bg-light">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">EV Yard Items</label>
                                                <select class="form-select form-select-sm" id="ev_yard_select">
                                                    <option value="">-- Select --</option>
                                                    {% for item in ev_yard_items %}
                                                    <option value="{{ item.split(' - ')[0] }}">{{ item }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">Draft Items</label>
                                                <select class="form-select form-select-sm" id="draft_select">
                                                    <option value="">-- Select --</option>
                                                    {% for item in draft_items %}
                                                    <option value="{{ item.split(' - ')[0] }}">{{ item }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <small class="text-muted">Selecting an item will populate the item number field above.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location -->
                            <div class="mb-3">
                                <label for="location" class="form-label">Location *</label>
                                <input type="text" class="form-control" id="location" 
                                       name="location" placeholder="e.g., Engine Room STBD AFT, Pilot House FWD PORT Console" 
                                       required spellcheck="true">
                                <small class="form-text text-muted">
                                    Be specific with location details including: compartment, side (PORT/STBD), position (FWD/AFT), deck level, frame numbers, equipment location
                                </small>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Brief Summary) *</label>
                                <textarea class="form-control" id="description" name="description" 
                                          rows="2" maxlength="200" required spellcheck="true"
                                          placeholder="Brief 1-2 sentence description (max 200 characters)"></textarea>
                                <small class="form-text text-muted">
                                    Example: "Port & Stbd ME Exhaust insulation overhaul"
                                </small>
                            </div>
                            
                            <!-- Detail -->
                            <div class="mb-3">
                                <label for="detail" class="form-label">Detail (Complete Description) *</label>
                                <textarea class="form-control" id="detail" name="detail" 
                                          rows="6" required spellcheck="true"
                                          placeholder="Include: What needs to be done, Why, Scope of work, WO numbers, Equipment specs, Regulatory requirements"></textarea>
                                <small class="form-text text-muted">
                                    Provide comprehensive details including what needs to be done, why, scope, WO numbers, equipment specs, and any regulatory requirements.
                                </small>
                            </div>
                            
                            <!-- Operator Furnished Material -->
                            <div class="mb-3">
                                <label for="references" class="form-label">Operator Furnished Material (OFM)</label>
                                <textarea class="form-control" id="references" name="references" 
                                          rows="3" spellcheck="true"
                                          placeholder="If known, list materials on order or onboard (e.g., part numbers, descriptions). Otherwise write 'None'."></textarea>
                                <small class="form-text text-muted">
                                    List any materials, parts, or equipment that need to be provided for this work item.
                                </small>
                            </div>
                            
                            <hr class="my-4">

                            <!-- Enhanced Photos Section -->
                            <h5 class="mb-3">üì∏ Photos</h5>
                            <p class="text-muted small mb-3">
                                Drag and drop photos or click to upload (Maximum {{ max_photos }})
                            </p>

                            <div id="photoUploadContainer" data-max-photos="{{ max_photos }}" data-min-photos="{{ min_photos }}">
                                <!-- Photo upload UI will be injected here by photo-upload.js -->
                            </div>

                            <hr class="my-4">

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    ‚úì Submit Work Item
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- TAB 2: IN PROGRESS -->
                    <div class="tab-pane fade" id="progress-pane" role="tabpanel">
                        <h4 class="mb-3">In Progress Items ({{ in_progress_items|length }})</h4>
                        
                        {% if in_progress_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item #</th>
                                        <th>Location</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Submitted By</th>
                                        <th>Photos</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in in_progress_items %}
                                    <tr>
                                        <td><strong>{{ item.item_number }}</strong></td>
                                        <td>{{ item.location|truncate(30) }}</td>
                                        <td>{{ item.description|truncate(40) }}</td>
                                        <td>{{ status_badge(item.status, item, true, 'sm') }}</td>
                                        <td>{{ item.submitter_name }}</td>
                                        <td>{{ item.photos|length }}</td>
                                        <td>
                                            {% if item.submitter_name == crew_name or item.assigned_to == crew_name %}
                                                {% if item.status in ['Needs Revision', 'Awaiting Photos'] %}
                                                <a href="{{ url_for('crew.edit_assigned_item', item_id=item.id) }}" 
                                                   class="btn btn-sm btn-warning">Edit</a>
                                                {% else %}
                                                <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                                   class="btn btn-sm btn-info">View</a>
                                                {% endif %}
                                            {% else %}
                                            <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                               class="btn btn-sm btn-info">View</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p class="mb-0">No items in progress at this time.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- TAB 3: COMPLETED -->
                    <div class="tab-pane fade" id="completed-pane" role="tabpanel">
                        <h4 class="mb-3">Completed Items ({{ completed_items|length }})</h4>
                        
                        {% if completed_items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item #</th>
                                        <th>Location</th>
                                        <th>Description</th>
                                        <th>Submitted By</th>
                                        <th>Photos</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in completed_items %}
                                    <tr>
                                        <td><strong>{{ item.item_number }}</strong></td>
                                        <td>{{ item.location|truncate(30) }}</td>
                                        <td>{{ item.description|truncate(40) }}</td>
                                        <td>{{ item.submitter_name }}</td>
                                        <td>{{ item.photos|length }}</td>
                                        <td>
                                            <a href="{{ url_for('crew.view_item', item_id=item.id) }}" 
                                               class="btn btn-sm btn-success">View</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p class="mb-0">No completed items yet.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/photo-upload.js') }}"></script>
<script>
// Reference dropdown selection - populate main item number input
document.getElementById('ev_yard_select').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('item_number').value = this.value;
        document.getElementById('draft_select').value = ''; // Clear other dropdown
    }
});

document.getElementById('draft_select').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('item_number').value = this.value;
        document.getElementById('ev_yard_select').value = ''; // Clear other dropdown
    }
});

// Form submission - append photos to form data
document.getElementById('workItemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Create FormData from the form
    const formData = new FormData(this);

    // Remove any existing photo data (old system compatibility)
    formData.delete('photos');
    formData.delete('photo_captions');

    // Add photos from the new upload manager
    if (window.photoUploadManager) {
        window.photoUploadManager.appendToFormData(formData);
    }

    // Submit the form
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Redirect to success page or reload
            window.location.href = response.url;
        } else {
            return response.text().then(text => {
                throw new Error('Form submission failed: ' + text);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('There was an error submitting the form. Please try again.');
    });
});
</script>
{% endblock %}
