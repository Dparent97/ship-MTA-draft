{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Work Item Dashboard</h2>
    <span class="badge bg-secondary fs-6">{{ pagination.total if pagination else work_items|length }} Total Items</span>
</div>

<!-- Enhanced Filters -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="GET" class="row g-3" id="filterForm">
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-funnel"></i> Status Filter</label>
                <select class="form-select" name="status" onchange="this.form.submit()">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                    <option value="Submitted" {% if status_filter == 'Submitted' %}selected{% endif %}>Submitted</option>
                    <option value="In Review by DP" {% if status_filter == 'In Review by DP' %}selected{% endif %}>In Review by DP</option>
                    <option value="In Review by AL" {% if status_filter == 'In Review by AL' %}selected{% endif %}>In Review by AL</option>
                    <option value="Needs Revision" {% if status_filter == 'Needs Revision' %}selected{% endif %}>Needs Revision</option>
                    <option value="Awaiting Photos" {% if status_filter == 'Awaiting Photos' %}selected{% endif %}>Awaiting Photos</option>
                    <option value="Completed Review" {% if status_filter == 'Completed Review' %}selected{% endif %}>Completed Review</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-sort-down"></i> Sort By</label>
                <select class="form-select" name="sort" onchange="this.form.submit()">
                    <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Newest First</option>
                    <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Oldest First</option>
                    <option value="item_number" {% if sort_by == 'item_number' %}selected{% endif %}>Item Number</option>
                    <option value="submitter" {% if sort_by == 'submitter' %}selected{% endif %}>Submitter</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-search"></i> Search</label>
                <input type="text" class="form-control" name="search" id="searchInput"
                       placeholder="Search items..." value="{{ search_query or '' }}">
            </div>
        </form>
    </div>
</div>

<!-- Batch Actions -->
<div class="card mb-4">
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.download_batch') }}" id="batchForm">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" id="selectAll" class="form-check-input me-2">
                    <label for="selectAll">Select All</label>
                    <span class="badge bg-info ms-2" id="selectedCount">0 selected</span>
                </div>
                <button type="submit" class="btn btn-success" id="downloadBatchBtn" disabled>
                    Download Selected (.zip)
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modern Card Grid Layout -->
<div class="work-items-grid">
    {% for item in work_items %}
    <div class="work-item-card card shadow-sm h-100">
        <!-- Card Header with Checkbox -->
        <div class="card-header bg-white border-bottom-0 p-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="card-title mb-1 fw-bold text-primary">{{ item.item_number }}</h5>
                    <span class="badge status-badge
                        {% if item.status == 'Submitted' %}bg-primary
                        {% elif item.status == 'In Review by DP' %}bg-warning text-dark
                        {% elif item.status == 'In Review by AL' %}bg-warning text-dark
                        {% elif item.status == 'Needs Revision' %}bg-danger
                        {% elif item.status == 'Awaiting Photos' %}bg-info text-dark
                        {% elif item.status == 'Completed Review' %}bg-success
                        {% else %}bg-secondary{% endif %}">
                        {{ item.status }}
                    </span>
                </div>
                <input type="checkbox" class="form-check-input item-checkbox ms-2"
                       value="{{ item.id }}" form="batchForm" name="item_ids[]"
                       style="width: 1.25rem; height: 1.25rem;">
            </div>
        </div>

        <!-- Photo Tiles - Compact Grid -->
        <div class="photo-tiles-container">
            {% if item.photos and item.photos|length > 0 %}
                <div class="photo-tiles-grid">
                    {% for photo in item.photos[:4] %}
                        <div class="photo-tile">
                            <img src="{{ url_for('serve_upload', filename=photo.filename) }}"
                                 alt="Photo {{ loop.index }}"
                                 loading="lazy">
                        </div>
                    {% endfor %}
                    {% if item.photos|length > 4 %}
                        <div class="photo-tile photo-tile-more">
                            <div class="photo-tile-overlay">
                                <span>+{{ item.photos|length - 4 }}</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="photo-tiles-placeholder">
                    <i class="bi bi-image text-muted"></i>
                    <span class="text-muted small">No photos</span>
                </div>
            {% endif %}
        </div>

        <!-- Card Body -->
        <div class="card-body p-3">
            <p class="card-text text-truncate-2 mb-2">
                <strong>Description:</strong> {{ item.description }}
            </p>
            <div class="work-item-meta text-muted small">
                <div class="mb-1">
                    <i class="bi bi-geo-alt-fill"></i> {{ item.location[:40] }}{% if item.location|length > 40 %}...{% endif %}
                </div>
                <div class="mb-1">
                    <i class="bi bi-person-fill"></i> {{ item.submitter_name }}
                </div>
                <div>
                    <i class="bi bi-calendar-event"></i> {{ format_datetime(item.submitted_at) }}
                </div>
            </div>
        </div>

        <!-- Card Footer with Actions -->
        <div class="card-footer bg-white border-top p-3">
            <div class="d-grid gap-2">
                <a href="{{ url_for('admin.view_item', item_id=item.id) }}"
                   class="btn btn-primary btn-sm">
                    <i class="bi bi-eye-fill"></i> View Details
                </a>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('admin.download_single', item_id=item.id) }}"
                       class="btn btn-outline-success">
                        <i class="bi bi-download"></i> Download
                    </a>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="confirmDelete('{{ item.id }}', '{{ item.item_number }}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center text-muted py-5">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <p class="mt-3">No work items found</p>
    </div>
    {% endfor %}
</div>

<!-- Pagination Controls -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Previous Button -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin.dashboard', page=pagination.prev_num, status=status_filter, sort=sort_by, search=search_query) if pagination.has_prev else '#' }}">
                Previous
            </a>
        </li>

        <!-- Page Numbers -->
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.dashboard', page=page_num, status=status_filter, sort=sort_by, search=search_query) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}

        <!-- Next Button -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin.dashboard', page=pagination.next_num, status=status_filter, sort=sort_by, search=search_query) if pagination.has_next else '#' }}">
                Next
            </a>
        </li>
    </ul>

    <!-- Page Info -->
    <div class="text-center text-muted mt-2">
        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} to {{ min(pagination.page * pagination.per_page, pagination.total) }} of {{ pagination.total }} items
    </div>
</nav>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Batch selection logic
const checkboxes = document.querySelectorAll('.item-checkbox');
const selectAll = document.getElementById('selectAll');
const selectedCount = document.getElementById('selectedCount');
const downloadBtn = document.getElementById('downloadBatchBtn');

function updateSelectedCount() {
    const checked = document.querySelectorAll('.item-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
    downloadBtn.disabled = checked === 0;
}

if (selectAll) {
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedCount();
    });
}

checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

updateSelectedCount();

// Search functionality with debounce
let searchTimeout;
const searchInput = document.getElementById('searchInput');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            document.getElementById('filterForm').submit();
        }, 500); // 500ms debounce
    });
}

// Delete confirmation
function confirmDelete(itemId, itemNumber) {
    if (confirm(`Are you sure you want to delete work item "${itemNumber}"?\n\nThis will permanently delete:\n- The work item\n- All associated photos\n- All comments and history\n\nThis action cannot be undone!`)) {
        showToast('Deleting work item...', 'info');

        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/delete/${itemId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Toast notification system
function showToast(message, type = 'info') {
    // Remove any existing toasts
    const existingToast = document.querySelector('.custom-toast');
    if (existingToast) {
        existingToast.remove();
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.className = `custom-toast alert alert-${type} alert-dismissible fade show`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    // Add to page
    document.body.appendChild(toast);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (toast && toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 150);
        }
    }, 5000);
}

// Show toast for flash messages (success/error operations)
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert:not(.custom-toast)');
    alerts.forEach(alert => {
        // Auto-dismiss alerts after 5 seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
});
</script>
{% endblock %}

